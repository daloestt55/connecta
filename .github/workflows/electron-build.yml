name: Build Electron Desktop

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Desktop
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Electron app (Windows)
        env:
          ELECTRON: true
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: npm run build:win
      
      - name: List build artifacts
        shell: pwsh
        run: |
          if (Test-Path "release") {
            Write-Host "‚úÖ Build successful!" -ForegroundColor Green
            Write-Host ""
            Write-Host "Build artifacts:" -ForegroundColor Cyan
            Get-ChildItem "release" -File | ForEach-Object {
              $size = [math]::Round($_.Length / 1MB, 2)
              Write-Host "  üì¶ $($_.Name) - $size MB" -ForegroundColor White
            }
          } else {
            Write-Host "‚ùå No release folder found" -ForegroundColor Red
            exit 1
          }
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: connecta-windows-${{ github.sha }}
          path: |
            release/*.exe
            release/*.yml
            release/*.blockmap
          retention-days: 30
          if-no-files-found: error
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/Connecta-Setup-*.exe
            release/Connecta-Portable-*.exe
            release/*.yml
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## üéâ Connecta Desktop v${{ github.ref_name }}
            
            ### üì• –ó–∞–≥—Ä—É–∑–∫–∞
            
            - **Connecta-Setup-*.exe** - –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è Windows (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
            - **Connecta-Portable-*.exe** - –ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è (–±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
            
            ### ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
            - üñ•Ô∏è –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            - üåê –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç (Supabase)
            - üí¨ –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            - üìÅ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ (–¥–æ 50MB)
            - üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å Row Level Security
            
            ### üìã –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
            - Windows 10/11 (64-bit)
            - 200 MB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
            - –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–±–æ—Ä–∫—É –¥–ª—è macOS –∏ Linux
  # build-macos:
  #   name: Build macOS Desktop
  #   runs-on: macos-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #     
  #     - name: Install dependencies
  #       run: npm ci
  #     
  #     - name: Build Electron app (macOS)
  #       env:
  #         ELECTRON: true
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: npm run build:mac
  #     
  #     - name: Upload macOS artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: connecta-macos-${{ github.sha }}
  #         path: |
  #           release/*.dmg
  #           release/*.zip
  #         retention-days: 30

  # build-linux:
  #   name: Build Linux Desktop
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #     
  #     - name: Install dependencies
  #       run: npm ci
  #     
  #     - name: Build Electron app (Linux)
  #       env:
  #         ELECTRON: true
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: npm run build:linux
  #     
  #     - name: Upload Linux artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: connecta-linux-${{ github.sha }}
  #         path: |
  #           release/*.AppImage
  #           release/*.deb
  #         retention-days: 30
